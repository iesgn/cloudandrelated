---
layout: presentacion
title: What is kubernetes used for?
tema: white
---
<section>
  <h2>What is kubernetes used for?</h2>
    <p>
    Alberto Molina Coballes, José Luis Rodríguez Rodríguez and José Domingo Muñoz Rodríguez
  </p>
  <p><small>Cloud Computing in European schools. Project: 2017-1-ES01-KA202-038471</small></p>
  <p><img src="img/UE.png" width="250px" border="0"/>
    <img src="img/iesvalleinclan.png" width="250px" border="0"/>
  </p>
  <p>
    <a href="http://creativecommons.org/licenses/by-sa/3.0/">
      <img src="img/cc_by_sa.png" width="100px" border="0"/></a>
  </p>
  <p><small>Theme by: <a href="http://lab.hakim.se/reveal-js/#/">reveal.js</a></small></p>
</section>

<section>
  <h3>Kubernetes</h3>
  <p>Kubernetes is an application container orchrestator written in Go
  licensed under Apache-2.0, Google launched it on 2015, the project
  is currently maintained by the Cloud Native Computing Foundation
  (CNCF)</p>
  <p>Managing a cluster:</p>
  <pre><code>
kubectl get nodes
NAME     STATUS   ROLES    AGE     VERSION
nodo-1   Ready    master   2m32s   v1.12.2
nodo-2   Ready    &lt;none&gt;   42s     v1.12.2
nodo-3   Ready    &lt;none&gt;   42s     v1.12.2
 </code></pre>
</section>
<section>
<section>
  <h3>Kubernetes resources</h3>
  <img src="img/kubernetes1.png"/>
</section>
<section>
  <h3>Kubernetes elements (I)</h3>
  <ul>
    <li><strong>Pods</strong>: Kubernetes minimum unit. A set of
    containers (usually only one) sharing storage and with a unique IP
    address.</li>
    <li><strong>ReplicaSet</strong>: Defines the number of replicas of
    a specific pod. It provides: 
      <ul>
        <li>Avoid service outage</li>
        <li>Fault tolerance</li>
        <li>Dynamic Scalability</li>
      </ul>
  </li>
  </ul>
</section>
<section>
  <h3>Kubernetes elements (II)</h3>
  <ul>
    <li><strong>Deployment</strong>: It manages <em>ReplicaSets</em>
      and provides:
      <ul>
        <li>Continuous updates</li>
        <li>Automatic deployments</li>
      </ul>
    </li>
    <li>
      <strong>Service</strong>: Allow access to a pod.
    </li>
    <li><strong>Ingress</strong>: Reverse proxy to access to the
      application from an external network. It provides also a load
      balancer</li>
  </ul>
</section>

<section>
  <h3>Kubernetes elements (III)</h3>
  <ul>
    <li>There are others elements providing:</li>
    <ul>
      <li>Easy migrations</li>
      <li>Monitoring</li>
      <li>Role Based Access Control (RBAC)</li>
      <li>Continuous integration and continuous deployment</li>
    </ul>
  </li>
  </ul>
</section>
</section>
<section>
<section>
  <h3>Example: Fault tolerance</li>
</section>
<section>
  <ul><li>A deployment is created using the image <code>josedom24/aplicacionweb:v1</code>:</li></ul>
    <pre><code>
kubectl run pagweb --image josedom24/aplicacionweb:v1
    
kubectl get pod
NAME                     READY   STATUS    RESTARTS   AGE
pagweb-5d756cb86-wm4zg   1/1     Running   0          3m7s
</code></pre>
</section>
<section>
<ul><li>If the pod fails, Kubernetes creates a new one:</li></ul>    
<pre><code>
kubectl delete pod/pagweb-5d756cb86-wm4zg
pod "pagweb-5d756cb86-wm4zg" deleted

kubectl get pod
NAME                     READY   STATUS        RESTARTS   AGE
pagweb-5d756cb86-2w2xq   1/1     Running       0          21s
pagweb-5d756cb86-wm4zg   1/1     Terminating   0          4m56s
</code></pre>
</section>
<section>
<ul><li>One Deployment and one ReplicaSet have been created::</li></ul>
<pre><code>
kubectl get deploy
NAME     DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
pagweb   1         1         1            1           5m

kubectl get rs
NAME               DESIRED   CURRENT   READY   AGE
pagweb-5d756cb86   1         1         1       5m
</code></pre>
</section>
</section>
<section>
<section>
  <h3>Example: Scalability</h3>
</section>
<section>
  <ul><li>ReplicaSet is alos responsible for the replicas. The number
  of pods can be scaled when needed:</li></ul>
<pre><code>
kubectl scale deploy pagweb --replicas=3
deployment.extensions/pagweb scaled
</code></pre>
<ul><li>3 pods running on different nodes:</li></ul>
<pre><code>
kubectl get pod -o wide
NAME                     READY   STATUS    ...     NODE   ...
pagweb-5d756cb86-2w2xq   1/1     Running   ...   nodo-2   ...
pagweb-5d756cb86-gwfgf   1/1     Running   ...   nodo-3   ...
pagweb-5d756cb86-wppxj   1/1     Running   ...   nodo-3   ...
</code></pre>
</section>
</section>
<section>
<section>
    <h3>Example: Accessing to the application. Load balancing</h3>
</section>
<section>
  <ul><li>A Service resource must be created in order to allow access
  to the application:</li></ul>
  <pre><code>
kubectl expose deployment pagweb --port=80 --type=NodePort
service/pagweb exposed

kubectl get services
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
...
pagweb       NodePort    10.98.140.134   &lt;none&gt;        80:30848/TCP   18s
</code></pre>
</section>
<section>
  <ul><li>Service is available on port 30848 in the master node:</li></ul>
  <img src="img/kubernetes2.png"></img>
  <ul><li>Every time application is used a load balancer is used to
  access to one of the three nodes available</li></ul>
</section>
</section>
<section>
<section>
  <h3>Example: Continuous updates</h3>
</section>
<section>
  <ul><li>The deployment can be modified to update the application to
  the latest release. 3 new pods are created using latest release::</li></ul>
  <pre><code>
kubectl set image deployment pagweb pagweb=josedom24/aplicacionweb:v2
deployment.extensions/pagweb image updated

kubectl get pods
NAME                      READY   STATUS        RESTARTS   AGE
pagweb-5d756cb86-2w2xq    1/1     Terminating   0          25m
pagweb-5d756cb86-gwfgf    1/1     Terminating   0          21m
pagweb-5d756cb86-wppxj    1/1     Terminating   0          21m
pagweb-7f6d9648fc-6kzf4   1/1     Running       0          8s
pagweb-7f6d9648fc-bhb2z   1/1     Running       0          2s
pagweb-7f6d9648fc-r8vql   1/1     Running       0          5s
</code></pre>
</section>
<section>
  <ul><li>The latest release is now available:</li></ul>
  <img src="img/kubernetes3.png"></img>
</section>
</section>
<section>
<section>
  <h3>Example: Rollback</h3>
</section>
<section>
  <ul><li>The previous release can be deployed again:</li></ul>
  <pre><code>
kubectl rollout undo deployment/pagweb
deployment.extensions/pagweb

kubectl get pods
NAME                      READY   STATUS        RESTARTS   AGE
pagweb-5d756cb86-d4tn4    1/1     Running       0          12s
pagweb-5d756cb86-fvrfc    1/1     Running       0          6s
pagweb-5d756cb86-g6wsc    1/1     Running       0          9s
pagweb-7f6d9648fc-6kzf4   1/1     Terminating   0          8m58s
pagweb-7f6d9648fc-bhb2z   1/1     Terminating   0          8m52s
pagweb-7f6d9648fc-r8vql   1/1     Terminating   0          8m55s
</code></pre>
</section>
<section>
  <ul><li>And the previous release is now available:</li></ul>
  <img src="img/kubernetes2.png"></img>
  <ul><li>A previous state can be used when needed!</li></ul>
</section>
</section>
<section>
<section>
  <h3>Example: Routing.</h3>
</section>
<section>
  <ul><li>Ingress Controller is a reverse proxy, using routing rules
  the application can be available through a FQDN.</li></ul>
  <ul><li>A configuration file is needed: <code>ingress.yaml</code></li></ul>
  <pre><code>
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: pagweb
spec:
  rules:
  - host: pagweb.172.22.200.165.nip.io
    http:
      paths:
      - path: /
        backend:
          serviceName: pagweb
          servicePort: 80
  
  </code></pre>
</section>
<section>
  <ul><li>And the ingress resource is created:</li></ul>
  <pre><code>
kubectl create -f ingress.yaml 
ingress.extensions/pagweb created

kubectl get ingress
NAME     HOSTS                          ADDRESS   PORTS   AGE
pagweb   pagweb.172.22.200.165.nip.io             80      6s
 </code></pre>
</section>
<section>
  <ul><li>The applications is available using a FQDN:</li></ul>
  <img src="img/kubernetes4.png"></img>
</section>
</section>
<section>
<section>
  <h3>Example: Persistent volumes in Kubernetes</h3>
</section>
<section>
  <ul><li>The cluster manager must create a resource called
  PersistentVolume, where the total storage available is defined.</li>
  <li>In this example, a NFS unit shared between the nodes has been created:</li></ul>
  <pre><code>
kubectl get pv
NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE
nfs-pv   5Gi        RWX            Recycle          Available                                   6s
  </code></pre>
</section>
<section>
  <ul><li>A resource called PersistentVolumeClaim must be created to
  reserve the PersistentVolume, using the pvc.yaml file:</li></ul>
<pre><code>
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nfs-pvc
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi

</code></pre>
</section>
<section>
<pre><code>
kubectl create -f pvc.yaml 
persistentvolumeclaim/nfs-pvc created

kubectl get pvc
NAME      STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE
nfs-pvc   Bound    nfs-pv   5Gi        RWX                           4s
</code></pre>
<!-- <ul><li>Como podemos observar al crear el pvc se busca del conjunto de pv uno que cumpla sus requerimientos, y se asocian (status bound) por lo tanto el tamaño indicado en el pvc es el valor mínimo de tamaño que se necesita, pero el tamaño real será el mismo que el del pv asociado.</li></ul>  -->
</section>
<section>
  <ul><li>A new deployment is going to be launched using this volume:</li></ul>
  <pre><code>
      apiVersion: extensions/v1beta1
      kind: Deployment
      metadata:
        name: nginx
        labels:
          app: nginx
      spec:
        template:
          metadata:
            labels:
              app: nginx
          spec:
            containers:
            - image: nginx
              name: nginx
              ports:
              - name: http
                containerPort: 80
              volumeMounts:
              - mountPath: /usr/share/nginx/html
                name: nfs-vol
            volumes:
            - name: nfs-vol
              persistentVolumeClaim:
                claimName: nfs-pvc
        </code></pre>
</section>
<section>
  <ul><li>The deployment and the associated service are created:</li></ul>
  <pre><code>
kubectl create -f nginx-deploy.yaml 
deployment.extensions/nginx created

kubectl expose deploy nginx --port=80 --type=NodePort
service/nginx exposed

kubectl get deploy,service
NAME                           DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.extensions/nginx    1         1         1            1           86s
      
NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
service/nginx        NodePort    10.110.53.26    &lt;none&gt;        80:30196/TCP   15s
  </code></pre>
</section>
<section>
  <ul><li>Trying to access to the application, but it's not available:</li></ul>
  <img src="img/kubernetes5.png"/>
</section>
<section>
  <ul><li>Writing any content on the shared directory and the
  application becomes available:</li></ul>
  <pre><code>
echo "It works..." | ssh debian@172.22.200.165 'cat >> /var/shared/index.html' 
  </code></pre>
  <img src="img/kubernetes6.png"/>
</section>
</section>
